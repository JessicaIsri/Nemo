image: docker:latest
services:
  - docker:dind

maven-build: 
  image: "maven:3-jdk-11"
  script: "mvn -f nemo/pom.xml compile"
  services: 
    - "postgres:latest"
  stage: build
  
maven-test: 
  image: "ubuntu:18.04"
  script:
    - sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
    - wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
    - apt-get update
    - apt-get -y install postgresql-10
    - apt-get -y install postgresql-10-postgis-2.4
    - apt-get -y install postgresql-10-postgis-scripts
    - apt-get -y install postgis
    - "adduser postgres"
    - ""
    - "apt-get update"
    - "apt-get -y install postgresql"
    - "apt-get -y install postgis"
    - "apt-get -y install postgresql-10-postgis-3"
    - su postgres
    - "psql -h \"postgres\" -U postgres -c \"ALTER USER postgres WITH PASSWORD 'admin'\" -d template1"
    - export PGPASSWORD='admin'
    - "psql -h \"postgres\" -U postgres -c \"create extension postgis;\""
    - "mvn -f nemo/pom.xml test"
  services: 
    - "postgres:latest"
    - liquibase/liquibase
    - mdillon/postgis:latest
  stage: test
  variables: 
    EXTDIR: /usr/share/postgresql/13/extension/
    PGDATA: /var/lib/postgresql/data
    POSTGRES_DB: postgres
    POSTGRES_HOST_AUTH_METHOD: trust
    POSTGRES_PASSWORD: admin
    POSTGRES_USER: postgres
    PSQL: "psql -v ON_ERROR_STOP=1"
stages: 
  - build
  - test

